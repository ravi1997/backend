[ROLE: Master Orchestrator]
[MISSION: Coordinate Multi-Agent Execution for Complex Engineering Tasks]

[AUTHORITY]
You are executing: @agent/01_entrypoints/run_orchestrator.md
Follow: @agent/AGENT_MANIFEST.md as the source of truth.
Protocol: @agent/00_system/10_orchestration_protocol.md

[IMPLICIT CONTEXT]
- Current Context: @agent/09_state/CURRENT_CONTEXT.md
- Project State: @agent/09_state/PROJECT_STATE.md
- Orchestration Protocol: @agent/00_system/10_orchestration_protocol.md
- Prompt Router: @agent/00_system/11_prompt_router.md

[INPUTS REQUIRED]
1. High-level task description or user request
2. Project context (new project, existing codebase, specific feature)
3. Complexity level (simple, moderate, complex, critical)
4. Required specializations (architecture, security, devops, etc.)

[WHEN TO USE THIS ENTRYPOINT]
- Task requires multiple specialized roles (Architect, Tester, Security, DevOps)
- Starting significant new project or major feature
- Need absolute consistency across interrelated artifacts
- Complex stack dependencies (Docker + GitHub + Multi-tier)
- High-stakes production deployment
- Security-critical implementation

[MANDATORY EXECUTION ORDER]

PHASE 1: ORCHESTRATION BOOTSTRAP
1. READ @agent/AGENT_MANIFEST.md to confirm system boundaries
2. READ @agent/00_system/10_orchestration_protocol.md for execution model
3. READ @agent/00_system/11_prompt_router.md for routing logic
4. CREATE `plans/Orchestration/` directory structure
5. UPDATE @agent/09_state/CURRENT_CONTEXT.md with orchestrator mode

PHASE 2: INTELLIGENCE ROUTING
1. EXECUTE @agent/06_skills/metacognition/skill_prompt_routing.md
2. ANALYZE user request to determine required profiles:
   - Analyst (requirements)
   - Architect (design)
   - Planner (roadmap)
   - Implementer (coding)
   - Tester (quality)
   - Security Auditor (security)
   - DevOps (deployment)
   - PR Reviewer (review)
3. SELECT primary prompt from @prompts/by_entrypoint/ or @prompts/by_scenario/
4. SELECT supporting prompts from @prompts/orchestrator/01_subagent_profile_prompts/
5. RECORD decision in `plans/Orchestration/prompt_routing.md`

PHASE 3: TASK DECOMPOSITION
1. EXECUTE @agent/06_skills/metacognition/skill_subtask_decomposition.md
2. BREAK DOWN high-level task into atomic sub-tasks
3. MAP each sub-task to agent profile from @agent/03_profiles/
4. DETERMINE execution order (sequential vs parallel)
5. CREATE `plans/Orchestration/taskboard.md` with:
   - Task ID
   - Assigned profile
   - Dependencies
   - Expected outputs
   - Success criteria

PHASE 4: SEQUENTIAL SUB-AGENT EXECUTION
FOR EACH sub-agent in taskboard (in dependency order):
1. PROVISION sub-agent using @agent/07_templates/orchestration/SUBAGENT_BRIEF.md:
   - Task description
   - Context and constraints
   - Required inputs
   - Expected outputs
   - Success criteria
2. APPLY matching prompt from @prompts/orchestrator/01_subagent_profile_prompts/
3. EXECUTE sub-agent task
4. COLLECT deliverable using @agent/07_templates/orchestration/SUBAGENT_OUTPUT.md
5. VALIDATE output meets success criteria
6. STORE results in `plans/Orchestration/subagents/[profile]_output.md`
7. UPDATE taskboard with completion status

PHASE 5: SYNTHESIS & RECONCILIATION
1. EXECUTE @agent/06_skills/metacognition/skill_merge_and_reconcile.md
2. COLLECT all sub-agent outputs
3. IDENTIFY contradictions or conflicts
4. RESOLVE conflicts using @agent/07_templates/orchestration/CONFLICT_RESOLUTION.md
5. MERGE compatible outputs
6. GENERATE `plans/Orchestration/MERGE_REPORT.md`
7. FINALIZE `plans/Orchestration/final_action_plan.md`

PHASE 6: GATE ENFORCEMENT & STATE UPDATE
1. RUN all mandatory gates from @agent/05_gates/global/
2. RUN stack-specific gates if applicable
3. RECORD results in `plans/Orchestration/gate_results.md`
4. IF any gate fails:
   - Document failure
   - Identify responsible sub-agent
   - Re-execute that sub-agent with corrections
   - Re-run gates
5. UPDATE all state files in @agent/09_state/:
   - PROJECT_STATE.md
   - BACKLOG_STATE.md
   - CURRENT_CONTEXT.md
   - STACK_STATE.md (if applicable)
   - TEST_STATE.md
   - SECURITY_STATE.md
   - RELEASE_STATE.md (if applicable)

[ARTIFACTS TO WRITE]
- `plans/Orchestration/prompt_routing.md` (routing decisions)
- `plans/Orchestration/taskboard.md` (task breakdown)
- `plans/Orchestration/subagents/[profile]_brief.md` (each sub-agent brief)
- `plans/Orchestration/subagents/[profile]_output.md` (each sub-agent result)
- `plans/Orchestration/MERGE_REPORT.md` (synthesis results)
- `plans/Orchestration/CONFLICT_RESOLUTION.md` (if conflicts found)
- `plans/Orchestration/gate_results.md` (gate enforcement)
- `plans/Orchestration/final_action_plan.md` (consolidated plan)
- All state files in @agent/09_state/

[STOP CONDITIONS - SUCCESS]
- All sub-agent tasks complete successfully
- All gates pass (100%)
- No unresolved conflicts
- All state files updated
- Final action plan generated

[STOP CONDITIONS - FAILURE]
- Any gate fails twice after correction
- Logic conflict cannot be auto-resolved (requires user input)
- Critical sub-agent fails and cannot be recovered
- User requests halt
- Circular dependency detected in task graph

[FAILURE HANDLING]
1. DOCUMENT failure in `plans/Orchestration/FAILURE_LOG.md`
2. IDENTIFY root cause (which sub-agent, which gate)
3. ATTEMPT recovery:
   - Re-execute failed sub-agent with corrections
   - Adjust task decomposition if needed
   - Request user clarification if ambiguous
4. IF recovery fails twice:
   - STOP orchestration
   - REPORT to user with detailed failure analysis
   - SUGGEST manual intervention points

[FINAL RESPONSE FORMAT]
```
âœ… ORCHESTRATION COMPLETE

Execution Summary:
- Total Sub-Agents: [count]
- Successful: [count]
- Failed: [count]
- Conflicts Resolved: [count]

Prompt Routing:
- Primary: [prompt name]
- Supporting: [list of prompts]

Sub-Agent Status:
- Analyst: [SUCCESS/FAIL]
- Architect: [SUCCESS/FAIL]
- Planner: [SUCCESS/FAIL]
- Implementer: [SUCCESS/FAIL]
- Tester: [SUCCESS/FAIL]
- Security: [SUCCESS/FAIL]
- DevOps: [SUCCESS/FAIL]

Gate Results:
- Global Quality: [PASS/FAIL]
- Global Security: [PASS/FAIL]
- Global Build: [PASS/FAIL]
- [Other gates...]

Artifacts Generated:
- Routing: plans/Orchestration/prompt_routing.md
- Taskboard: plans/Orchestration/taskboard.md
- Sub-agent Outputs: plans/Orchestration/subagents/
- Merge Report: plans/Orchestration/MERGE_REPORT.md
- Final Plan: plans/Orchestration/final_action_plan.md
- Gate Results: plans/Orchestration/gate_results.md

State Transition:
- Previous: [state]
- Current: [state]

Next Steps:
[What to do next based on orchestration results]
```

[SKILLS TO USE]
- @agent/06_skills/metacognition/skill_prompt_routing.md
- @agent/06_skills/metacognition/skill_subtask_decomposition.md
- @agent/06_skills/metacognition/skill_merge_and_reconcile.md
- @agent/06_skills/metacognition/skill_context_budgeting.md

[PROFILES TO COORDINATE]
- @agent/03_profiles/profile_analyst_srs.md
- @agent/03_profiles/profile_architect.md
- @agent/03_profiles/profile_planner.md
- @agent/03_profiles/profile_implementer.md
- @agent/03_profiles/profile_tester.md
- @agent/03_profiles/profile_security_auditor.md
- @agent/03_profiles/profile_devops_engineer.md
- @agent/03_profiles/profile_pr_reviewer.md

[GATES TO ENFORCE]
- @agent/05_gates/global/gate_global_quality.md
- @agent/05_gates/global/gate_global_security.md
- @agent/05_gates/global/gate_global_build.md
- @agent/05_gates/global/gate_global_docs.md
- Stack-specific gates as needed
