<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ form.title }}</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    {% if form.ui == 'tabbed' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .tabs {
            flex-direction: column;
            border-right: 1px solid #ddd;
        }

        .tab-btn {
            padding: 10px;
            cursor: pointer;
            background: none;
            border: none;
            text-align: left;
            width: 100%;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: #007bff;
            color: white;
        }

        .tab-btn.completed {
            background: #28a745;
            color: white;
        }

        .tab-content {
            padding: 20px;
        }
    </style>
    {% endif %}
</head>

<body>
    <h1>{{ form.title }}</h1>
    <p>{{ form.description or '' }}</p>

    {% if form.ui == 'flex' %}
    <form hx-post="/form/api/v1/form/{{ form.id }}/responses" hx-target="#result" hx-swap="outerHTML" method="POST">
        {% with last_version=form.versions|last %}
            {% for section in last_version.sections %}
            <fieldset>
                <legend>{{ section.title }}</legend>
                <p><em>{{ section.description or '' }}</em></p>

                {% if section.ui == 'flex' %}

                    {% for question in section.questions %}
                    <div style="margin-bottom: 1rem;">
                        <label for="{{ question.id }}">
                            {{ question.label }}
                            {% if question.is_required %}<strong>*</strong>{% endif %}
                            {% if question.help_text %}<br><small>{{ question.help_text }}</small>{% endif %}
                        </label>

                        {% if question.field_type == 'input' %}
                        <input type="text" name="{{ question.id }}" id="{{ question.id }}"
                            value="{{ question.default_value or '' }}" {% if question.is_required %}required{% endif %}>

                        {% elif question.field_type == 'number' %}
                        <input type="number" name="{{ question.id }}" id="{{ question.id }}"
                            value="{{ question.default_value or '' }}" {% if question.is_required %}required{% endif %}>

                        {% elif question.field_type == 'textarea' %}
                        <textarea name="{{ question.id }}" id="{{ question.id }}" {% if question.is_required %}required{% endif
                            %}>{{ question.default_value or '' }}</textarea>

                        {% elif question.field_type == 'radio' %}
                        {% for option in question.options %}
                        <label>
                            <input type="radio" name="{{ question.id }}" value="{{ option.option_value }}" {% if
                                option.is_default %}checked{% endif %}>
                            {{ option.option_label }}
                        </label><br>
                        {% endfor %}

                        {% elif question.field_type == 'checkbox' %}
                        {% for option in question.options %}
                        <label>
                            <input type="checkbox" name="{{ question.id }}" value="{{ option.option_value }}">
                            {{ option.option_label }}
                        </label><br>
                        {% endfor %}

                        {% elif question.field_type == 'select' %}
                        {# Check if any option is marked as default #}
                        {% set has_default = question.options | selectattr('is_default') | list | length > 0 %}

                        <select name="{{ question.id }}" id="{{ question.id }}">
                            {% if not has_default %}
                            <option value="" selected>Select an option</option>
                            {% endif %}

                            {% for option in question.options %}
                            <option value="{{ option.option_value }}" {% if option.is_default %}selected{% endif %}>
                                {{ option.option_label }}
                            </option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                    {% endfor %}

                {% endif %}


                {% if section.ui == 'grid-cols-2' %}
                {% set left_column = [] %}
                {% set right_column = [] %}

                {% for question in section.questions %}
                {% if loop.index0 % 2 == 0 %}
                {% set _ = left_column.append(question) %}
                {% else %}
                {% set _ = right_column.append(question) %}
                {% endif %}
                {% endfor %}

                <div style="display: flex; gap: 2rem;">
                    <!-- Left Column (odd-indexed questions) -->
                    <div style="flex: 1;">
                        {% for question in left_column %}
                        <div style="margin-bottom: 1rem;">
                            <label for="{{ question.id }}">
                                {{ question.label }}
                                {% if question.is_required %}<strong>*</strong>{% endif %}
                                {% if question.help_text %}<br><small>{{ question.help_text }}</small>{% endif %}
                            </label>

                            {% if question.field_type == 'input' %}
                            <input type="text" name="{{ question.id }}" id="{{ question.id }}"
                                value="{{ question.default_value or '' }}" {% if question.is_required %}required{% endif %}>

                            {% elif question.field_type == 'number' %}
                            <input type="number" name="{{ question.id }}" id="{{ question.id }}"
                                value="{{ question.default_value or '' }}" {% if question.is_required %}required{% endif %}>

                            {% elif question.field_type == 'textarea' %}
                            <textarea name="{{ question.id }}" id="{{ question.id }}" {% if question.is_required
                                %}required{% endif %}>{{ question.default_value or '' }}</textarea>

                            {% elif question.field_type == 'radio' %}
                            {% for option in question.options %}
                            <label>
                                <input type="radio" name="{{ question.id }}" value="{{ option.option_value }}" {% if
                                    option.is_default %}checked{% endif %}>
                                {{ option.option_label }}
                            </label><br>
                            {% endfor %}

                            {% elif question.field_type == 'checkbox' %}
                            {% for option in question.options %}
                            <label>
                                <input type="checkbox" name="{{ question.id }}" value="{{ option.option_value }}">
                                {{ option.option_label }}
                            </label><br>
                            {% endfor %}

                            {% elif question.field_type == 'select' %}
                            {# Check if any option is marked as default #}
                            {% set has_default = question.options | selectattr('is_default') | list | length > 0 %}

                            <select name="{{ question.id }}" id="{{ question.id }}">
                                {% if not has_default %}
                                <option value="" selected>Select an option</option>
                                {% endif %}

                                {% for option in question.options %}
                                <option value="{{ option.option_value }}" {% if option.is_default %}selected{% endif %}>
                                    {{ option.option_label }}
                                </option>
                                {% endfor %}
                            </select>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Right Column (even-indexed questions) -->
                    <div style="flex: 1;">
                        {% for question in right_column %}
                        <div style="margin-bottom: 1rem;">
                            <label for="{{ question.id }}">
                                {{ question.label }}
                                {% if question.is_required %}<strong>*</strong>{% endif %}
                                {% if question.help_text %}<br><small>{{ question.help_text }}</small>{% endif %}
                            </label>

                            {% if question.field_type == 'input' %}
                            <input type="text" name="{{ question.id }}" id="{{ question.id }}"
                                value="{{ question.default_value or '' }}" {% if question.is_required %}required{% endif %}>

                            {% elif question.field_type == 'number' %}
                            <input type="number" name="{{ question.id }}" id="{{ question.id }}"
                                value="{{ question.default_value or '' }}" {% if question.is_required %}required{% endif %}>

                            {% elif question.field_type == 'textarea' %}
                            <textarea name="{{ question.id }}" id="{{ question.id }}" {% if question.is_required
                                %}required{% endif %}>{{ question.default_value or '' }}</textarea>

                            {% elif question.field_type == 'radio' %}
                            {% for option in question.options %}
                            <label>
                                <input type="radio" name="{{ question.id }}" value="{{ option.option_value }}" {% if
                                    option.is_default %}checked{% endif %}>
                                {{ option.option_label }}
                            </label><br>
                            {% endfor %}

                            {% elif question.field_type == 'checkbox' %}
                            {% for option in question.options %}
                            <label>
                                <input type="checkbox" name="{{ question.id }}" value="{{ option.option_value }}">
                                {{ option.option_label }}
                            </label><br>
                            {% endfor %}

                            {% elif question.field_type == 'select' %}

                            {# Check if any option is marked as default #}
                            {% set has_default = question.options | selectattr('is_default') | list | length > 0 %}

                            <select name="{{ question.id }}" id="{{ question.id }}">
                                {% if not has_default %}
                                <option value="" selected>Select an option</option>
                                {% endif %}

                                {% for option in question.options %}
                                <option value="{{ option.option_value }}" {% if option.is_default %}selected{% endif %}>
                                    {{ option.option_label }}
                                </option>
                                {% endfor %}
                            </select>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

            </fieldset>
            {% endfor %}
        {% endwith %}


        <button type="submit">Submit</button>
    </form>
    {% endif %}
    {% if form.ui == 'tabbed' %}
    <form id="dynamic-form" class="container py-4" hx-post="/form/api/v1/form/{{ form.id }}/responses"
        hx-target="#result" hx-swap="outerHTML" method="POST">
        <div class="row">
    
            <div class="col-3 tabs">
                {% for section in form.sections %}
                <button type="button" class="tab-btn" data-tab="section-{{ loop.index }}">
                    {{ section.title }}
                </button>
                {% endfor %}
            </div>
    
            <div class="col-9">
                {% for section in form.sections %}
                <div class="tab-content d-none" id="section-{{ loop.index }}">
                    <h4>{{ section.title }}</h4>
                    <p class="text-muted">{{ section.description or '' }}</p>
    
                    {% for question in section.questions %}
                    <div class="mb-3">
                        <label class="form-label" for="{{ question.id }}">{{ question.label }}
                            {% if question.is_required %}<span class="text-danger">*</span>{% endif %}
                            {% if question.help_text %}<br><small class="text-muted">{{ question.help_text }}</small>{%
                            endif %}
                        </label>

                        {% if question.field_type == 'input' %}
                        <input class="form-control" type="text" name="{{ question.id }}" id="{{ question.id }}" {%
                            if question.is_required %}required{% endif %}>
    
                        {% elif question.field_type == 'number' %}
                        <input class="form-control" type="number" name="{{ question.id }}" id="{{ question.id }}" {%
                            if question.is_required %}required{% endif %}>
    
                        {% elif question.field_type == 'textarea' %}
                        <textarea class="form-control" name="{{ question.id }}" id="{{ question.id }}" {% if
                            question.is_required %}required{% endif %}></textarea>
    
                        {% elif question.field_type == 'radio' %}
                        {% for option in question.options %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="{{ question.id }}" value="{{
                                option.option_value }}" {% if option.is_default %}checked{% endif %}>
                            <label class="form-check-label">{{ option.option_label }}</label>
                        </div>
                        {% endfor %}
    
                        {% elif question.field_type == 'checkbox' %}
                        {% for option in question.options %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="{{ question.id }}" value="{{
                                option.option_value }}">
                            <label class="form-check-label">{{ option.option_label }}</label>
                        </div>
                        {% endfor %}
    
                        {% elif question.field_type == 'select' %}
                        <select class="form-select" name="{{ question.id }}" id="{{ question.id }}">
                            {% for option in question.options %}
                            <option value="{{ option.option_value }}" {% if option.is_default %}selected{% endif %}>{{
                                option.option_label }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
    
        </div>
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>
    
    <script>
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('d-none'));

                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.remove('d-none');
            });
        });

        document.querySelector('.tab-btn').click();

        document.getElementById('dynamic-form').addEventListener('change', () => {
            document.querySelectorAll('.tab-content').forEach(content => {
                const inputs = content.querySelectorAll('input[required], textarea[required], select[required]');
                const isComplete = Array.from(inputs).every(input => input.value.trim() !== '');

                const tabButton = document.querySelector(`.tab-btn[data-tab="${content.id}"]`);

                if (isComplete) {
                    tabButton.classList.add('completed');
                } else {
                    tabButton.classList.remove('completed');
                }
            });
        });
    </script>
    {% endif %}


    <div id="result"></div>
</body>

</html>